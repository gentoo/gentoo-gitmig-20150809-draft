--- lib/rfbServer.cc.orig	2003-06-27 16:39:09.000000000 -0400
+++ lib/rfbServer.cc	2003-06-27 16:39:58.000000000 -0400
@@ -29,9 +29,11 @@
 using std::cout;
 using std::endl;
 
-namespace rfb {
+bool isdaemon = false;
 
+namespace rfb {
 
+void Server::toggleDaemon(bool t) { isdaemon = t; }
 
 Server::Server()
   : stateProtocolVersion( this )
@@ -142,6 +144,7 @@
   blocksX = (framebuffer->width + blockWidth - 1) / blockWidth;
   blocksY = (framebuffer->height + blockHeight - 1) / blockHeight;
   blocks = (Block*) malloc( sizeof(Block) * blocksX * blocksY );
+  if (!isdaemon) {
   cerr << "framebuffer->width: " << framebuffer->width << endl;
   cerr << "framebuffer->height: " << framebuffer->height << endl;
   cerr << "blockWidth: " << blockWidth << endl;
@@ -149,6 +152,7 @@
   cerr << "blocksX: " << blocksX << endl;
   cerr << "blocksY: " << blocksY << endl;
   cerr << "blocks: " << blocks << endl;
+  }
 //  ResetBlocks();
 }
 
@@ -234,8 +238,10 @@
 
 void Server::handleClientInitialisation( ClientInitialisation &clientInitialisation )
 {
+  if (!isdaemon) {
   cout << "-> handleClientInitialisation" << endl;
   cout << "shared flag: " << (int) clientInitialisation.shared_flag << endl;
+  }
   
   ServerInitialisation serverInitialisation;
   getServerInitialisation( serverInitialisation );
@@ -674,6 +680,7 @@
   }
   if ( size == 4 ) {
     if ( offset == size ) {
+      if (!isdaemon)
       cerr << "encoding: " << (int) encodings.encoding[encodings.count] << endl;
       encodings.count = encodings.count + 1;
       data = (unsigned char*) &(encodings.encoding[encodings.count]);
--- include/rfbServer.h.orig	2003-06-27 16:39:19.000000000 -0400
+++ include/rfbServer.h	2003-06-27 16:39:58.000000000 -0400
@@ -342,6 +342,7 @@
   void ResetBlocks();
   void DeleteBlocks();
   void BlocksToHints();
+  void toggleDaemon(bool);
 
   Block *blocks;
   unsigned int blockWidth, blockHeight;
--- x0rfbserver/x0rfbserver.cc.orig	2003-06-27 16:39:25.000000000 -0400
+++ x0rfbserver/x0rfbserver.cc	2003-06-27 16:43:54.000000000 -0400
@@ -72,6 +72,7 @@
 OXClient *clientX;
 const OXWindow *root;
 Display *dpy;
+extern bool isdaemon;
 
 
 namespace rfb {
@@ -347,11 +348,13 @@
 
 void OXServerMainFrame::CreateFramebuffer()
 {
+  if (!isdaemon) {
   cerr << "CreateFramebuffer() start" << endl;
   cerr << "dpy" << dpy << endl;
   cerr << "id " << root->GetId() << endl;
   cerr << "w  " << clientX->GetDisplayWidth() << endl;
   cerr << "h  " << clientX->GetDisplayHeight() << endl;
+  }
   framebufferImage = XGetImage( dpy,
                                 root->GetId(),
 				0,
@@ -360,6 +363,7 @@
 				clientX->GetDisplayHeight(),
 				AllPlanes,
 				ZPixmap );
+  if (!isdaemon)
   cerr << "FI " << framebufferImage << endl;
   framebuffer.width        = framebufferImage->width;
   framebuffer.height       = framebufferImage->height;
@@ -397,9 +401,11 @@
   }
   scanner = new XUpdateScanner( dpy, root->GetId(), &framebuffer );
 
+  if (!isdaemon) {
   cerr << "fpf " << int(framebuffer.pixelFormat.bits_per_pixel) << endl;
 
   cerr << "CreateFramebuffer() end" << endl;
+  }
 }
 
 
@@ -616,6 +622,7 @@
             event.same_screen = True;
             event.state = modifier;
             event.keycode = kc;
+            if (!isdaemon)
             cerr << "XSendEvent (XKeyEvent)" << endl;
             if ( kc != NoSymbol )
                 XSendEvent( dpy,
@@ -703,6 +710,7 @@
             }
         }
         else {
+            if (!isdaemon)
             cerr << "XWarpPointer" << endl;
             XWarpPointer( dpy,
                           None,
@@ -751,9 +759,11 @@
 #ifdef USE_ZLIB_WARREN
 void BaseServer::handleEnableZlib( CARD8 level )
 {
+  if (!isdaemon)
   cerr << "EnableZlib: level " << (int) level << endl;
   Server::handleEnableZlib( level );
   bufferedConnection->enableSenderDeflation( level );
+  if (!isdaemon)
   cerr << "Zlib enabled" << endl;
 }
 #endif // USE_ZLIB_WARREN
@@ -803,6 +813,8 @@
   , key_Hyper_L( 0 )
   , key_Hyper_R( 0 )
 {
+  toggleDaemon(isdaemon);
+  if (!isdaemon)
   cerr << "BaseServer() start" << endl;
   memcpy( password, "\0\0\0\0\0\0\0\0", 8 );
   strncpy( password, properties.password, 8 );
@@ -820,12 +832,14 @@
   fh = new OSocketFileHandler( mainFrame, fd, XCM_READABLE | XCM_WRITABLE );
   mainFrame->RegisterServer( this );
   connection->send( (unsigned char*) RFB_PROTOCOL_VERSION, 12 );
+  if (!isdaemon)
   cerr << "BaseServer() end" << endl;
 }
 
 
 BaseServer::~BaseServer()
 {
+  if (!isdaemon)
   cerr << "~BaseServer() start" << endl;
   DeleteBlocks();
   mainFrame->UnregisterServer( this );
@@ -833,6 +847,7 @@
   delete fh;
   shutdown( fd, 2 );
   close( fd );
+  if (!isdaemon)
   cerr << "~BaseServer() end" << endl;
 }
 
@@ -860,6 +875,7 @@
     << "       x0rfbserver -stdio" << endl
     << "       x0rfbserver -about" << endl
     << "       x0rfbserver -help" << endl
+    << "       x0rfbserver -daemon" << endl
     << endl
     << "<options>" << endl
     << "       -shared" << endl
@@ -871,7 +887,7 @@
 
 void parseCommandLine_x0rfbserver( int argc, char **argv )
 {
-  enum { UNDEF, ABOUT, STDIO } mode;
+  enum { UNDEF, ABOUT, STDIO, DAEMON } mode;
   mode = UNDEF;
 
   int i = 1;
@@ -891,6 +907,13 @@
       if ( mode == UNDEF ) mode = STDIO;
       else printHelp_x0rfbserver();
       i++;
+    } else
+
+    if ( !strcmp( argv[i], "-daemon" ) ) {
+      if ( mode == UNDEF ) mode = DAEMON;
+      else printHelp_x0rfbserver();
+      isdaemon = true;
+      i++;
     } else printHelp_x0rfbserver();
   }
 
@@ -920,6 +943,21 @@
     break;
 
     
+    case DAEMON: {
+      if (fork()) { return; }
+      setsid();
+      if (fork()) { exit(0); }
+      chdir("/");
+      close(0);
+      close(1);
+      close(2);
+      clientX = new OXClient;
+      root = clientX->GetRoot();
+      dpy = root->GetDisplay();
+      new rfb::OXServerMainFrame( 48, 48 );
+      exit( 0 );
+    }
+    break;
       
     case STDIO: {
       clientX = new OXClient;
--- x0rfbserver/XUpdateScanner.cc.orig	2003-06-27 16:39:30.000000000 -0400
+++ x0rfbserver/XUpdateScanner.cc	2003-06-27 16:39:58.000000000 -0400
@@ -386,6 +386,7 @@
     }
   }
 
+  if (!isdaemon)
   cerr << "TILES: " << tilec << endl;
   
   if ( properties.showMousePointer ) {
--- x0rfbserver/XUpdateScanner.h.orig	2002-02-12 18:57:01.000000000 -0500
+++ x0rfbserver/XUpdateScanner.h	2003-06-27 16:39:58.000000000 -0400
@@ -23,6 +23,7 @@
 
 
 #include "rfbServer.h"
+extern bool isdaemon;
 
 
 namespace rfb {
