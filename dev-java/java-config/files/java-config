
#! /bin/sh
# 
# Copyright 1999-2001 Gentoo Technologies, Inc.
# Distributed under the terms of the GNU General Public License, v2 or later
# Maintainer: Tools Team <tools@gentoo.org>
# Author: Karl Trygve Kalleberg <karltk@gentoo.org>
# $Header: /var/cvsroot/gentoo-x86/dev-java/java-config/files/java-config,v 1.6 2002/04/09 21:34:00 karltk Exp $

version=0.2.0
all_params="$*"

if [ -e /etc/env.d/20java ] ; then
	oldpath=$PATH
	. /etc/env.d/20java
	PATH=$oldpath:$PATH
fi


if [ -z "$JAVA_HOME" ] ; then
	echo "!!! No Java installation found" > /dev/stderr
	echo "!!! Use --set-system-vm to select default system JVM" > /dev/stderr
fi

usage() {
        cat <<EOF
Usage: java-config [OPTIONS] [LIBRARIES]
Options:
	[--javac]
	[--java]
	[--jar]
	[--jdk-home]
	[--jre-home]
	[--java-version]
	[--classpath[=package-name]]
	[--full-classpath=package-name]
	[--exec=filename]
	[--list-available-packages]
	[--list-available-vms]
	[--set-system-vm=<vm-id>]
	[--set-user-vm=<vm-id>]
EOF
	echo "Using ${JAVA_HOME}"
	exit $1
}

find_exec() {
	if [ -f ${JAVA_HOME}/bin/$1 ] ; then
		echo ${JAVA_HOME}/bin/$1
	elif [ -f ${JAVA_HOME}/jre/bin/$1 ] ; then
		echo ${JAVA_HOME}/jre/bin/$1
	else
		echo $1 not found > /dev/stderr
		exit 1
	fi
}                                                                       

classpathfor()
{
	local pkgs=`echo $1 | sed "s/,/ /g"`
	local total=""
	for i in $pkgs ; do
		if [ -f /usr/share/${i}/classpath.env ] ; then
			total="${total}`cat /usr/share/${i}/classpath.env`"
		else
			echo "Package ${i} not found" > /dev/stderr
			exit 1
		fi
	done
	echo $total
}

findpluginpath() {

	# This covers Sun and Blackdown

	rootpath=${JAVA_HOME}/jre/plugin/i386
	
	if [ $1 == "ns4" ] || [ $1 == "netscape4" ] ; then
		for i in ${rootpath}/{ns4,netscape4}/javaplugin.so ; do
			if [ -e $i ] ; then
				echo $i
				break
			fi
		done
	elif [ $1 == "ns6" ] || [ $1 == "netscape6" ] || [ $1 == "moz" ] || [ $1 == "mozilla" ] ; then
		for i in ${rootpath}/{mozilla,ns600,netscape6}/{libjavaplugin_oji,javaplugin_oji}.so ; do
			if [ -e $i ] ; then
				echo $i
				break
			fi
		done
	else
		echo Browser "$1" unknow > /dev/stderr
	fi

	# This covers IBM

	rootpath=${JAVA_HOME}
	if [ $1 == "ns4" ] || [ $1 == "netscape4" ] ; then
		for i in ${rootpath}/{,jre}/bin/javaplugin.so ; do
			if [ -e $i ] ; then
				echo $i
				break
			fi
		done
	elif [ $1 == "ns6" ] || [ $1 == "netscape6" ] || [ $1 == "moz" ] || [ $1 == "mozilla" ] ; then
		for i in ${rootpath}/{,jre}/bin/libjavaplugin_oji.so ; do
			if [ -e $i ] ; then
				echo $i
				break
			fi
		done
	fi
}

function vm_shortname() {
	basename $1 | sed -e "s/20//" #-e "s/-[0-9]\..*//"
}

function vm_version()  {
	( . $1 ; echo "$VERSION ($i)" )
}

function vm_envvars() {
	local file=$1
	local system="$2"

	( . $file ;
  	for i in $ENV_VARS ; do
		if [ $i == "ADDPATH" ] && [ -z "$system" ]; then
			echo "PATH=\${PATH}:${!i}"
		elif [ $i == "ADDPATH" ] && [ "$system" ]; then
			echo "PATH=${!i}"
			echo "ROOTPATH=${!i}"
		elif [ $i == "ADDLDPATH" ] ; then
			if [ "$system" ]; then
				echo "LDPATH=${!i}"
			fi
		else
			echo "${i}=${!i}"
		fi
	done
	)
}

function set_vm() {
	local vm=$1
	local cfgpath=$2
	local cfgfile=$3
	local system=""
	if [ "$cfgpath" == "/etc/env.d" ] ; then
		system="yes"
	fi
	local found=""

	for i in /etc/env.d/java/20*-* ; do
		if [ $vm == `vm_shortname $i` ] ; then
			echo "Now using `vm_version $i`"
			mkdir -p $cfgpath
			echo "# Autogenerated by java-config $version" > ${cfgpath}/${cfgfile}
			echo "# Cmd: $0 $all_params" >> ${cfgpath}/${cfgfile}
			vm_envvars $i $system >> ${cfgpath}/${cfgfile}
			found="yes"
		fi
	done
	if [ -z "$found" ] ; then
		echo "$vm not found"
	fi
}

while test $# -gt 0; do

	case "$1" in
	-*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
	*) optarg= ;;
	esac
       
	case $1 in
		--debug)
			set -x
		;;
		--browser-plugin=*)
			pluginpath=`findpluginpath $optarg`
			if [ -n "$pluginpath" ] ; then
				echo `basename $pluginpath`
			else
				echo "Plugin not found" > /dev/stderr
			fi
		;;
		--full-browser-plugin-path=*)
			findpluginpath $optarg
		;;
		--classpath)
			echo ${CLASSPATH}
		;;
		--classpath=*)
			classpathfor $optarg
		;;
		--full-classpath=*)
			echo "${CLASSPATH}:`classpathfor $optarg`."
		;;
		--jdk-home)
			echo ${JDK_HOME}
		;;
		--jre-home)
			echo ${JRE_HOME}
		;;
		--javac)
			find_exec javac
		;;
		--java)
			find_exec java
		;;
		--jar)
			find_exec jar
		;;
		--java-version)
			`find_exec java` -version
		;;
		--exec=*)
			find_exec $optarg
		;;
		--version)
			echo java-config $version
		;;
		--list-available-packages)
			for i in `ls /usr/share/*/classpath.env` ; do
				dn=`dirname $i`
				echo `basename $dn`
			done
		;;
		--list-available-vms)
			for i in /etc/env.d/java/20*-* ; do
				echo "[`vm_shortname $i`] `vm_version $i`"
			done
		;;
		--set-system-vm=*)
			set_vm $optarg /etc/env.d 20java
		;;
		--set-user-vm=*)
			set_vm $optarg $HOME/.gentoo java-env 
		;;
		*)
			usage
		;;
	esac
	shift
done
