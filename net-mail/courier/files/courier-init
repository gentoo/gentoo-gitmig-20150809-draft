#!/sbin/runscript
# Portions Copyright 2003 Gentoo Linux
#
# script originally from Courier distfile original name = courier.sysvinit
# adapted for Gentoo by Brian Jackson
#

prefix="/usr"
exec_prefix="/usr/bin"
sysconfdir="/etc/courier"
sbindir="/usr/sbin"
libexecdir="/usr/lib/courier"
datadir="/usr/share/courier"
#authlib="/usr/lib/courier/authlib"


depend() {
	need net
}

checkconfig() {

	[ -f ${sysconfdir}/pop3d-ssl ] && . ${sysconfdir}/pop3d-ssl

	# If we do not have a certificate, make one up.
	[ ! -f "${datadir}/pop3d.pem" ] && \
	ebegin " generating-POP3-SSL-certificate..." && "${sbindir}/mkpop3dcert"

	[ -f ${sysconfdir}/imapd-ssl ] && . ${sysconfdir}/imapd-ssl

	# If we do not have a certificate, make one up.
	[ ! -f ${datadir}/imapd.pem ] && \
	ebegin " generating-IMAP-SSL-certificate..." && "${sbindir}/mkimapdcert"

	# First time after install create aliases.dat and smtpaccess.dat

	[ -f ${sysconfdir}/aliases.dat ] || ${sbindir}/makealiases

	[ -f ${sysconfdir}/${ACCESSFILE}.dat ] || ${sbindir}/makesmtpaccess

	[ -f ${sysconfdir}/${ACCESSFILE}.dat ] || ${sbindir}/makesmtpaccess-msa

	# we need this for now to check for the old init scripts
	if [ -f /etc/init.d/courier-authdaemond ] ; then
		einfo "As of courier-0.42.2-r2, there is only one init script used"
		einfo "you can remove /etc/init.d/courier-*. /etc/init.d/courier is"
		einfo "the only one you need."
	fi

}

start() {
	# Start daemons.
	ebegin "Starting Courier mail server:"

	checkconfig || return 1

	ebegin " Starting courierfilterd"
	${sbindir}/courierfilter start

	[ -x ${libexecdir}/authlib/authdaemond ] && \
	${libexecdir}/authlib/authdaemond start && ebegin " Starting authdaemond"

	[ -x ${sbindir}/courierldapaliasd ] && \
	${sbindir}/courierldapaliasd start && ebegin " Starting courierldapaliasd"

	ebegin " Starting courierd"
	${sbindir}/courier start

	# start esmtpd if so written
	[ -f ${sysconfdir}/esmtpd ] && source ${sysconfdir}/esmtpd
	case x$ESMTPDSTART in
	x[yY]*)
		ebegin " Starting esmtpd"
		${sbindir}/esmtpd start
		;;
	esac

	# start esmtpd-msa if so written
	[ -f ${sysconfdir}/esmtpd-msa ] && source ${sysconfdir}/esmtpd-msa
	case x$ESMTPDSTART in
	x[yY]*)
		ebegin " Starting esmtpd-msa"
		${sbindir}/esmtpd-msa start
		;;
	esac

	# start pop3d if so written
	[ -f ${sysconfdir}/pop3d ] && source ${sysconfdir}/pop3d
	case x$POP3DSTART in
	x[yY]*)
		ebegin " courier-pop3d"
		${sbindir}/courier-pop3d start
		;;
	esac

	# start pop3d-ssl if so written
	[ -f ${sysconfdir}/pop3d-ssl ] && source ${sysconfdir}/pop3d-ssl
	case x$POP3DSTART in
	x[yY]*)
		ebegin " courier-pop3d"
		${sbindir}/courier-pop3d-ssl start
		;;
	esac

	[ -f ${sysconfdir}/imapd ] && source ${sysconfdir}/imapd
	case x$IMAPDSTART in
	x[yY]*)
		ebegin " courier-imapd"
		${sbindir}/courier-imapd start
		;;
	esac

	[ -f ${sysconfdir}/imapd-ssl ] && source ${sysconfdir}/imapd-ssl
	case x$IMAPDSSLSTART in
	x[yY]*)
		ebegin " courier-imapd-ssl"
		${sbindir}/courier-imapd-ssl start
		;;
	esac

	eend $?
}

stop() {
	ebegin "Stopping Courier mail server:"

	ebegin " Stopping courier-esmtpd"
	${sbindir}/esmtpd stop

	ebegin " Stopping courier-esmtpd-msa"
	${sbindir}/esmtpd-msa stop

	[ -x ${sbindir}/courier-pop3d ] && \
		ebegin " Stopping courier-pop3d" && ${sbindir}/courier-pop3d stop

	[ -x ${sbindir}/pop3d-ssl ] && \
		ebegin " Stopping courier-pop3d-ssl" && ${sbindir}/courier-pop3d-ssl stop

	[ -x ${sbindir}/courier-imapd ] && \
		ebegin " Stopping courier-imapd" && ${sbindir}/courier-imapd stop


	[ -x ${sbindir}/courier-imapd-ssl ] && \
		ebegin " Stopping courier-imapd-ssl" && ${sbindir}/courier-imapd-ssl stop

	ebegin " Stopping courierd"
	${sbindir}/courier stop

	[ -x ${sbindir}/courierldapaliasd ] && \
	( ${sbindir}/courierldapaliasd stop ; ebegin " Stoping courierldapaliasd" )

	[ -x ${libexecdir}/authlib/authdaemond ] && \
	( ${libexecdir}/authlib/authdaemond stop ; ebegin " Stoping authdaemond" )

	${sbindir}/courierfilter stop
	ebegin " Stopping courierfilterd"

	eend $?
}



# restart() {
# 	ebegin "Restarting courier filterd"
# 	/usr/sbin/courierfilter restart
# 	eend $?
# }
